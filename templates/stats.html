{% extends 'base.html' %}

{% block title %}Entre Linhas — Estatísticas{% endblock %}

{% block extra_head %}
<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .stat-card {
    @apply bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 transition-all duration-300 hover:shadow-lg;
  }
  
  .stat-number {
    @apply text-3xl font-bold text-primary-600 dark:text-primary-400;
  }
  
  .stat-label {
    @apply text-sm text-gray-500 dark:text-gray-400 uppercase tracking-wider;
  }
  
  .chart-container {
    @apply relative h-64 md:h-80;
  }
</style>
{% endblock %}

{% block content %}
<div class="bg-gradient-to-b from-primary-600 to-primary-800 text-white py-12">
  <div class="container mx-auto px-6 text-center">
    <h1 class="text-4xl font-bold mb-4">Estatísticas da Comunidade</h1>
    <p class="text-xl opacity-90 max-w-2xl mx-auto">
      Dados anônimos sobre a atividade na plataforma Entre Linhas.
      Nenhuma informação pessoal é coletada ou exibida.
    </p>
  </div>
</div>

<div class="container mx-auto px-6 py-10">
  <!-- Resumo de estatísticas -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
    <div class="stat-card">
      <p class="stat-label">Total de Desabafos</p>
      <p class="stat-number">{{ post_stats.total_posts }}</p>
      <p class="mt-2 text-gray-600 dark:text-gray-300">Desabafos compartilhados na plataforma</p>
    </div>
    
    <div class="stat-card">
      <p class="stat-label">Total de Comentários</p>
      <p class="stat-number">{{ comment_stats.total_comments }}</p>
      <p class="mt-2 text-gray-600 dark:text-gray-300">Média de {{ "%.1f"|format(comment_stats.avg_comments) }} comentários por desabafo</p>
    </div>
    
    <div class="stat-card">
      <p class="stat-label">Total de Reações</p>
      <p class="stat-number">{{ reaction_stats.total_reactions }}</p>
      <p class="mt-2 text-gray-600 dark:text-gray-300">Demonstrações de apoio e empatia</p>
    </div>
  </div>
  
  <!-- Gráficos -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
    <!-- Gráfico de categorias -->
    <div class="stat-card">
      <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Desabafos por Categoria</h2>
      <div class="chart-container">
        <canvas id="categoryChart"></canvas>
      </div>
    </div>
    
    <!-- Gráfico de dias da semana -->
    <div class="stat-card">
      <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Desabafos por Dia da Semana</h2>
      <div class="chart-container">
        <canvas id="weekdayChart"></canvas>
      </div>
    </div>
    
    <!-- Gráfico de horas do dia -->
    <div class="stat-card">
      <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Desabafos por Hora do Dia</h2>
      <div class="chart-container">
        <canvas id="hourChart"></canvas>
      </div>
    </div>
    
    <!-- Gráfico de tipos de reação -->
    <div class="stat-card">
      <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Reações por Tipo</h2>
      <div class="chart-container">
        <canvas id="reactionChart"></canvas>
      </div>
    </div>
  </div>
  
  <!-- Desabafos mais comentados -->
  <div class="stat-card mb-10">
    <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Desabafos Mais Comentados</h2>
    
    {% if comment_stats.most_commented_posts %}
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead>
            <tr>
              <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Desabafo</th>
              <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Comentários</th>
            </tr>
          </thead>
          <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            {% for post in comment_stats.most_commented_posts %}
              <tr>
                <td class="px-6 py-4 whitespace-normal">
                  <div class="text-sm text-gray-900 dark:text-gray-100">{{ post.mensagem|truncate(100) }}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-primary-600 dark:text-primary-400">{{ post.comment_count }}</div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-gray-500 dark:text-gray-400">Nenhum desabafo comentado ainda.</p>
    {% endif %}
  </div>
  
  <!-- Desabafos com mais reações -->
  <div class="stat-card">
    <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Desabafos com Mais Reações</h2>
    
    {% if reaction_stats.most_reacted_posts %}
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead>
            <tr>
              <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Desabafo</th>
              <th class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Reações</th>
            </tr>
          </thead>
          <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            {% for post in reaction_stats.most_reacted_posts %}
              <tr>
                <td class="px-6 py-4 whitespace-normal">
                  <div class="text-sm text-gray-900 dark:text-gray-100">{{ post.mensagem|truncate(100) }}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-primary-600 dark:text-primary-400">{{ post.reaction_count }}</div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-gray-500 dark:text-gray-400">Nenhum desabafo com reações ainda.</p>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Configuração de cores para os gráficos
    const colors = {
      light: {
        backgroundColor: [
          'rgba(66, 153, 225, 0.7)',
          'rgba(72, 187, 120, 0.7)',
          'rgba(237, 100, 166, 0.7)',
          'rgba(246, 173, 85, 0.7)',
          'rgba(159, 122, 234, 0.7)',
          'rgba(237, 137, 54, 0.7)',
          'rgba(56, 178, 172, 0.7)',
          'rgba(113, 128, 150, 0.7)'
        ],
        borderColor: [
          'rgba(66, 153, 225, 1)',
          'rgba(72, 187, 120, 1)',
          'rgba(237, 100, 166, 1)',
          'rgba(246, 173, 85, 1)',
          'rgba(159, 122, 234, 1)',
          'rgba(237, 137, 54, 1)',
          'rgba(56, 178, 172, 1)',
          'rgba(113, 128, 150, 1)'
        ]
      },
      dark: {
        backgroundColor: [
          'rgba(144, 205, 244, 0.7)',
          'rgba(154, 230, 180, 0.7)',
          'rgba(251, 182, 206, 0.7)',
          'rgba(254, 215, 170, 0.7)',
          'rgba(214, 188, 250, 0.7)',
          'rgba(254, 178, 107, 0.7)',
          'rgba(129, 230, 217, 0.7)',
          'rgba(160, 174, 192, 0.7)'
        ],
        borderColor: [
          'rgba(144, 205, 244, 1)',
          'rgba(154, 230, 180, 1)',
          'rgba(251, 182, 206, 1)',
          'rgba(254, 215, 170, 1)',
          'rgba(214, 188, 250, 1)',
          'rgba(254, 178, 107, 1)',
          'rgba(129, 230, 217, 1)',
          'rgba(160, 174, 192, 1)'
        ]
      }
    };
    
    // Detectar modo escuro
    const isDarkMode = document.documentElement.classList.contains('dark');
    const chartColors = isDarkMode ? colors.dark : colors.light;
    const textColor = isDarkMode ? '#e2e8f0' : '#2d3748';
    const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    
    // Configuração global para os gráficos
    Chart.defaults.color = textColor;
    Chart.defaults.scale.grid.color = gridColor;
    
    // Buscar dados para os gráficos via API
    fetch('/api/estatisticas')
      .then(response => response.json())
      .then(data => {
        // Gráfico de categorias
        new Chart(document.getElementById('categoryChart'), {
          type: 'pie',
          data: {
            labels: data.chart_data.posts_by_category.labels,
            datasets: [{
              data: data.chart_data.posts_by_category.data,
              backgroundColor: chartColors.backgroundColor,
              borderColor: chartColors.borderColor,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  padding: 20,
                  boxWidth: 12
                }
              }
            }
          }
        });
        
        // Gráfico de dias da semana
        new Chart(document.getElementById('weekdayChart'), {
          type: 'bar',
          data: {
            labels: data.chart_data.posts_by_weekday.labels,
            datasets: [{
              label: 'Desabafos',
              data: data.chart_data.posts_by_weekday.data,
              backgroundColor: chartColors.backgroundColor[0],
              borderColor: chartColors.borderColor[0],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            }
          }
        });
        
        // Gráfico de horas do dia
        new Chart(document.getElementById('hourChart'), {
          type: 'line',
          data: {
            labels: data.chart_data.posts_by_hour.labels,
            datasets: [{
              label: 'Desabafos',
              data: data.chart_data.posts_by_hour.data,
              backgroundColor: 'rgba(66, 153, 225, 0.2)',
              borderColor: chartColors.borderColor[0],
              borderWidth: 2,
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            }
          }
        });
        
        // Gráfico de tipos de reação
        new Chart(document.getElementById('reactionChart'), {
          type: 'doughnut',
          data: {
            labels: data.chart_data.reactions_by_type.labels,
            datasets: [{
              data: data.chart_data.reactions_by_type.data,
              backgroundColor: chartColors.backgroundColor,
              borderColor: chartColors.borderColor,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  padding: 20,
                  boxWidth: 12
                }
              }
            }
          }
        });
      })
      .catch(error => {
        console.error('Erro ao carregar dados de estatísticas:', error);
        document.querySelectorAll('.chart-container').forEach(container => {
          container.innerHTML = '<p class="text-center text-red-500 dark:text-red-400 py-10">Erro ao carregar gráfico</p>';
        });
      });
  });
</script>
{% endblock %}

